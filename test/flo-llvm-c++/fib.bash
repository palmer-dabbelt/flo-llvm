#include "tempdir.bash"

cat >test.flo <<EOF
Fib::io_ok = out/1 Fib::valid
Fib::io_in = out/32 Fib::range
reset = rst
T0 = add/32 Fib::cycle 1
T1 = gte/32 Fib::index Fib::range
T2 = eq Fib::valid 0
T3 = and T2 T1
T4 = mux T3 T0 Fib::cycle
Fib::cycle__update = mux reset 2 T4
Fib::cycle = reg T4 Fib::cycle__update
T5 = not/1 T2
T6 = mux T5 Fib::cycle Fib::range
Fib::range__update = mux reset 0 T6
Fib::range = reg T6 Fib::range__update
T7 = add/32 Fib::index 1
T8 = mux T2 T7 Fib::index
T9 = mux T5 1 T8
Fib::index__update = mux reset 0 T9
Fib::index = reg T9 Fib::index__update
T10 = mux T3 1 Fib::valid
T11 = mux T5 0 T10
Fib::valid__update = mux reset 1 T11
Fib::valid = reg T11 Fib::valid__update
T12 = add/32 Fib::sum0 Fib::sum1
T13 = mux T2 T12 Fib::sum1
T14 = mux T5 1 T13
Fib::sum1__update = mux reset 0 T14
Fib::sum1 = reg T14 Fib::sum1__update
T15 = mux T2 Fib::sum1 Fib::sum0
T16 = mux T5 0 T15
Fib::sum0__update = mux reset 0 T16
Fib::sum0 = reg T16 Fib::sum0__update
Fib::io_ot = out/32 Fib::sum0
EOF

cat >harness.c++ <<EOF
 #include "test.h++"

int main(int argc, const char **argv)
{
    int cycles = 0;
    const char *vcd_file = "/dev/null";

    for (int i = 1; i < argc; i++) {
        if (strcmp(argv[i], "--vcd") == 0) {
            i++;
            vcd_file = argv[i];
        } else if (strcmp(argv[i], "--cycles") == 0) {
            i++;
            cycles = atoi(argv[i]);
        } else {
            fprintf(stderr, "Unable to parse argument '%s'\n", argv[i]);
            abort();
        }
    }

    Fib_t dut;
    dut.init(false);

    FILE *vcd = fopen(vcd_file, "w");

    for (int cycle = 0; cycle < cycles; cycle++) {
        dut.clock_lo(cycle == 0);
        dut.clock_hi(cycle == 0);
        if (cycle > 0)
            dut.dump(vcd, cycle - 1);
    }

    fclose(vcd);

    return 0;
}
EOF

cat >gold.vcd <<"EOF"
$timescale 1ps $end
$scope module Fib $end
$var wire 1 N0 io_ok $end
$var wire 32 N1 io_in $end
$var wire 1 N2 reset $end
$var wire 32 N3 cycle $end
$var wire 32 N4 range $end
$var wire 32 N5 index $end
$var wire 1 N6 valid $end
$var wire 32 N7 sum1 $end
$var wire 32 N8 sum0 $end
$var wire 32 N9 io_ot $end
$upscope $end
$enddefinitions $end
$dumpvars
$end
#0
b1 N0
b00000000000000000000000000000000 N1
b00000000000000000000000000000010 N3
b00000000000000000000000000000010 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000000000 N9
#1
b0 N0
b00000000000000000000000000000010 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
#2
b00000000000000000000000000000011 N3
b00000000000000000000000000000011 N5
b1 N6
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#3
b1 N0
b00000000000000000000000000000011 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
#4
b0 N0
b00000000000000000000000000000011 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#5
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#6
b00000000000000000000000000000100 N3
b00000000000000000000000000000100 N5
b1 N6
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#7
b1 N0
b00000000000000000000000000000100 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000000010 N9
#8
b0 N0
b00000000000000000000000000000100 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#9
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#10
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#11
b00000000000000000000000000000101 N3
b00000000000000000000000000000101 N5
b1 N6
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#12
b1 N0
b00000000000000000000000000000101 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000000011 N9
#13
b0 N0
b00000000000000000000000000000101 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#14
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#15
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#16
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#17
b00000000000000000000000000000110 N3
b00000000000000000000000000000110 N5
b1 N6
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#18
b1 N0
b00000000000000000000000000000110 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000000101 N9
#19
b0 N0
b00000000000000000000000000000110 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#20
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#21
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#22
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#23
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#24
b00000000000000000000000000000111 N3
b00000000000000000000000000000111 N5
b1 N6
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#25
b1 N0
b00000000000000000000000000000111 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000001000 N9
#26
b0 N0
b00000000000000000000000000000111 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#27
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#28
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#29
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#30
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#31
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#32
b00000000000000000000000000001000 N3
b00000000000000000000000000001000 N5
b1 N6
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#33
b1 N0
b00000000000000000000000000001000 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000001101 N9
#34
b0 N0
b00000000000000000000000000001000 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#35
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#36
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#37
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#38
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#39
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#40
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#41
b00000000000000000000000000001001 N3
b00000000000000000000000000001001 N5
b1 N6
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#42
b1 N0
b00000000000000000000000000001001 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000010101 N9
#43
b0 N0
b00000000000000000000000000001001 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#44
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#45
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#46
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#47
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#48
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#49
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#50
b00000000000000000000000000001001 N5
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#51
b00000000000000000000000000001010 N3
b00000000000000000000000000001010 N5
b1 N6
b00000000000000000000000000110111 N7
b00000000000000000000000000100010 N8
b00000000000000000000000000010101 N9
#52
b1 N0
b00000000000000000000000000001010 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000100010 N9
#53
b0 N0
b00000000000000000000000000001010 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#54
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#55
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#56
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#57
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#58
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#59
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#60
b00000000000000000000000000001001 N5
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#61
b00000000000000000000000000001010 N5
b00000000000000000000000000110111 N7
b00000000000000000000000000100010 N8
b00000000000000000000000000010101 N9
#62
b00000000000000000000000000001011 N3
b00000000000000000000000000001011 N5
b1 N6
b00000000000000000000000001011001 N7
b00000000000000000000000000110111 N8
b00000000000000000000000000100010 N9
#63
b1 N0
b00000000000000000000000000001011 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000000110111 N9
#64
b0 N0
b00000000000000000000000000001011 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#65
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#66
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#67
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#68
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#69
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#70
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#71
b00000000000000000000000000001001 N5
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#72
b00000000000000000000000000001010 N5
b00000000000000000000000000110111 N7
b00000000000000000000000000100010 N8
b00000000000000000000000000010101 N9
#73
b00000000000000000000000000001011 N5
b00000000000000000000000001011001 N7
b00000000000000000000000000110111 N8
b00000000000000000000000000100010 N9
#74
b00000000000000000000000000001100 N3
b00000000000000000000000000001100 N5
b1 N6
b00000000000000000000000010010000 N7
b00000000000000000000000001011001 N8
b00000000000000000000000000110111 N9
#75
b1 N0
b00000000000000000000000000001100 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000001011001 N9
#76
b0 N0
b00000000000000000000000000001100 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#77
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#78
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#79
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#80
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#81
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#82
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#83
b00000000000000000000000000001001 N5
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#84
b00000000000000000000000000001010 N5
b00000000000000000000000000110111 N7
b00000000000000000000000000100010 N8
b00000000000000000000000000010101 N9
#85
b00000000000000000000000000001011 N5
b00000000000000000000000001011001 N7
b00000000000000000000000000110111 N8
b00000000000000000000000000100010 N9
#86
b00000000000000000000000000001100 N5
b00000000000000000000000010010000 N7
b00000000000000000000000001011001 N8
b00000000000000000000000000110111 N9
#87
b00000000000000000000000000001101 N3
b00000000000000000000000000001101 N5
b1 N6
b00000000000000000000000011101001 N7
b00000000000000000000000010010000 N8
b00000000000000000000000001011001 N9
#88
b1 N0
b00000000000000000000000000001101 N4
b00000000000000000000000000000001 N5
b0 N6
b00000000000000000000000000000001 N7
b00000000000000000000000000000000 N8
b00000000000000000000000010010000 N9
#89
b0 N0
b00000000000000000000000000001101 N1
b00000000000000000000000000000010 N5
b00000000000000000000000000000001 N8
b00000000000000000000000000000000 N9
#90
b00000000000000000000000000000011 N5
b00000000000000000000000000000010 N7
b00000000000000000000000000000001 N9
#91
b00000000000000000000000000000100 N5
b00000000000000000000000000000011 N7
b00000000000000000000000000000010 N8
#92
b00000000000000000000000000000101 N5
b00000000000000000000000000000101 N7
b00000000000000000000000000000011 N8
b00000000000000000000000000000010 N9
#93
b00000000000000000000000000000110 N5
b00000000000000000000000000001000 N7
b00000000000000000000000000000101 N8
b00000000000000000000000000000011 N9
#94
b00000000000000000000000000000111 N5
b00000000000000000000000000001101 N7
b00000000000000000000000000001000 N8
b00000000000000000000000000000101 N9
#95
b00000000000000000000000000001000 N5
b00000000000000000000000000010101 N7
b00000000000000000000000000001101 N8
b00000000000000000000000000001000 N9
#96
b00000000000000000000000000001001 N5
b00000000000000000000000000100010 N7
b00000000000000000000000000010101 N8
b00000000000000000000000000001101 N9
#97
b00000000000000000000000000001010 N5
b00000000000000000000000000110111 N7
b00000000000000000000000000100010 N8
b00000000000000000000000000010101 N9
#98
b00000000000000000000000000001011 N5
b00000000000000000000000001011001 N7
b00000000000000000000000000110111 N8
b00000000000000000000000000100010 N9
EOF

#include "harness.bash"
